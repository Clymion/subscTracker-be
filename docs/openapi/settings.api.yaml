openapi: 3.1.1

info:
  title: サブスク管理アプリ API - 設定・ラベル管理・マスターデータ関連
  description: 設定・ラベル管理・マスターデータ関連のAPI定義
  version: 1.0.0

# 共通定義参照
components:
  securitySchemes:
    bearerAuth:
      $ref: 'common.api.yaml#/components/securitySchemes/bearerAuth'
  responses:
    BadRequest:
      $ref: 'common.api.yaml#/components/responses/BadRequest'
    Unauthorized:
      $ref: 'common.api.yaml#/components/responses/Unauthorized' 
    Forbidden:
      $ref: 'common.api.yaml#/components/responses/Forbidden'
    NotFound:
      $ref: 'common.api.yaml#/components/responses/NotFound'

  schemas:
    # 設定関連のスキーマ
    CurrencySettings:
      type: object
      properties:
        base_currency:
          type: string
          description: 基準通貨
        auto_update:
          type: boolean
          description: 自動更新フラグ
        update_frequency:
          type: string
          description: 更新頻度
      required:
        - base_currency
        - auto_update

    CurrencySettingsUpdateRequest:
      type: object
      properties:
        base_currency:
          type: string
          description: 基準通貨
        auto_update:
          type: boolean
          description: 自動更新フラグ
        update_frequency:
          type: string
          description: 更新頻度
      required:
        - base_currency
        - auto_update

    PaymentMethod:
      type: object
      properties:
        id:
          type: string
          description: 支払い方法ID
        type:
          type: string
          description: 支払い方法タイプ
        card_brand:
          type: string
          description: カードブランド
        last_four_digits:
          type: string
          description: カード番号下4桁
        expiry_date:
          type: string
          description: 有効期限
        is_default:
          type: boolean
          description: デフォルトフラグ
      required:
        - id
        - type
        - is_default

    PaymentMethodCreateRequest:
      type: object
      properties:
        card_number:
          type: string
          description: カード番号
        expiry_date:
          type: string
          description: 有効期限
        security_code:
          type: string
          description: セキュリティコード
        cardholder_name:
          type: string
          description: カード名義
      required:
        - card_number
        - expiry_date
        - security_code
        - cardholder_name

    NotificationPreferences:
      type: object
      properties:
        channels:
          type: object
          properties:
            email:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                verified:
                  type: boolean
                  description: 検証済みフラグ
              required:
                - enabled
                - verified
            push:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                subscribed:
                  type: boolean
                  description: 購読済みフラグ
              required:
                - enabled
                - subscribed
          required:
            - email
            - push
        events:
          type: object
          properties:
            payment_due:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                reminder_days:
                  type: array
                  items:
                    type: integer
                  description: リマインダー日数
              required:
                - enabled
                - reminder_days
            trial_ending:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                reminder_days:
                  type: array
                  items:
                    type: integer
                  description: リマインダー日数
              required:
                - enabled
                - reminder_days
            payment_failed:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                retry_count:
                  type: integer
                  description: リトライ回数
              required:
                - enabled
                - retry_count
          required:
            - payment_due
            - trial_ending
            - payment_failed
      required:
        - channels
        - events

    NotificationPreferencesUpdateRequest:
      type: object
      properties:
        channels:
          type: object
          properties:
            email:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
            push:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
        events:
          type: object
          properties:
            payment_due:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                reminder_days:
                  type: array
                  items:
                    type: integer
                  description: リマインダー日数
            trial_ending:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                reminder_days:
                  type: array
                  items:
                    type: integer
                  description: リマインダー日数
            payment_failed:
              type: object
              properties:
                enabled:
                  type: boolean
                  description: 有効フラグ
                retry_count:
                  type: integer
                  description: リトライ回数

    Label:
      type: object
      properties:
        id:
          type: string
          description: ラベルID
        name:
          type: string
          description: ラベル名
        color:
          type: string
          description: ラベルの色
        usage_count:
          type: integer
          description: 使用数
      required:
        - id
        - name
        - color
        - usage_count

    LabelCreateRequest:
      type: object
      properties:
        name:
          type: string
          description: ラベル名
        color:
          type: string
          description: ラベルの色
      required:
        - name
        - color

    LabelUpdateRequest:
      type: object
      properties:
        name:
          type: string
          description: ラベル名
        color:
          type: string
          description: ラベルの色
          
    # 共通のスキーマ参照
    Error:
      $ref: 'common.api.yaml#/components/schemas/Error'

paths:
  # 通貨設定関連のAPI
  /users/{userId}/settings/currency:
    get:
      tags:
        - 通貨設定
      summary: 通貨設定の取得
      description: 指定されたユーザーの通貨設定を取得します
      operationId: getCurrencySettings
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/CurrencySettings'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags:
        - 通貨設定
      summary: 通貨設定の更新
      description: 指定されたユーザーの通貨設定を更新します
      operationId: updateCurrencySettings
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CurrencySettingsUpdateRequest'
      responses:
        '200':
          description: 正常に更新しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/CurrencySettings'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /exchange-rates/refresh:
    post:
      tags:
        - 通貨設定
      summary: 為替レートの手動更新
      description: 為替レートを手動で更新します
      operationId: refreshExchangeRates
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 正常に更新しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      updated_at:
                        type: string
                        format: date-time
                      rates:
                        type: object
                        additionalProperties:
                          type: number
                        examples:
                          USD: 1.0
                          JPY: 148.5
                          EUR: 0.92
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  # 支払い方法設定関連のAPI
  /users/{userId}/payment-methods:
    get:
      tags:
        - 支払い方法設定
      summary: 支払い方法一覧の取得
      description: 指定されたユーザーの支払い方法一覧を取得します
      operationId: getPaymentMethods
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      payment_methods:
                        type: array
                        items:
                          $ref: '#/components/schemas/PaymentMethod'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags:
        - 支払い方法設定
      summary: 支払い方法の追加
      description: 指定されたユーザーに新しい支払い方法を追加します
      operationId: createPaymentMethod
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentMethodCreateRequest'
      responses:
        '201':
          description: 正常に追加しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PaymentMethod'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/{userId}/payment-methods/{id}:
    patch:
      tags:
        - 支払い方法設定
      summary: 支払い方法の更新
      description: 指定された支払い方法を更新します
      operationId: updatePaymentMethod
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: 支払い方法ID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                is_default:
                  type: boolean
                  description: デフォルトの支払い方法として設定するかどうか
              required:
                - is_default
      responses:
        '200':
          description: 正常に更新しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/PaymentMethod'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - 支払い方法設定
      summary: 支払い方法の削除
      description: 指定された支払い方法を削除します
      operationId: deletePaymentMethod
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
        - name: id
          in: path
          description: 支払い方法ID
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 正常に削除しました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # 通知設定関連のAPI
  /users/{userId}/notification-preferences:
    get:
      tags:
        - 通知設定
      summary: 通知設定の取得
      description: 指定されたユーザーの通知設定を取得します
      operationId: getNotificationPreferences
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/NotificationPreferences'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    patch:
      tags:
        - 通知設定
      summary: 通知設定の更新
      description: 指定されたユーザーの通知設定を更新します
      operationId: updateNotificationPreferences
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationPreferencesUpdateRequest'
      responses:
        '200':
          description: 正常に更新しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/NotificationPreferences'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /users/{userId}/notifications/push/subscribe:
    post:
      tags:
        - 通知設定
      summary: プッシュ通知の購読
      description: プッシュ通知の購読情報を登録します
      operationId: subscribePushNotifications
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                subscription:
                  type: object
                  description: Push API Subscriptionオブジェクト
              required:
                - subscription
      responses:
        '200':
          description: プッシュ通知の購読に成功しました
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        
  /users/{userId}/notification-channels/email/verify:
    post:
      tags:
        - 通知設定
      summary: メール通知の検証
      description: メール通知チャネルを検証します
      operationId: verifyEmailNotificationChannel
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          description: ユーザーID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: 検証メールを送信しました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # ラベル管理関連のAPI
  /labels:
    get:
      tags:
        - ラベル管理
      summary: ラベル一覧の取得
      description: ラベルの一覧を取得します
      operationId: getLabels
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      labels:
                        type: array
                        items:
                          $ref: '#/components/schemas/Label'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
    post:
      tags:
        - ラベル管理
      summary: ラベルの作成
      description: 新しいラベルを作成します
      operationId: createLabel
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LabelCreateRequest'
      responses:
        '201':
          description: 正常に作成しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Label'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /labels/{id}:
    patch:
      tags:
        - ラベル管理
      summary: ラベルの更新
      description: 指定されたラベルを更新します
      operationId: updateLabel
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          description: ラベルID
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LabelUpdateRequest'
      responses:
        '200':
          description: 正常に更新しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Label'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags:
        - ラベル管理
      summary: ラベルの削除
      description: 指定されたラベルを削除します
      operationId: deleteLabel
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          description: ラベルID
          required: true
          schema:
            type: string
      responses:
        '204':
          description: 正常に削除しました
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  # マスターデータ関連のAPI
  /master/payment-methods:
    get:
      tags:
        - マスターデータ
      summary: 支払い方法一覧の取得
      description: 利用可能な支払い方法の一覧を取得します
      operationId: getMasterPaymentMethods
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      payment_methods:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              description: 支払い方法ID
                            name:
                              type: string
                              description: 支払い方法名
                          required:
                            - id
                            - name
        '401':
          $ref: '#/components/responses/Unauthorized'

  /master/payment-frequencies:
    get:
      tags:
        - マスターデータ
      summary: 支払い頻度一覧の取得
      description: 利用可能な支払い頻度の一覧を取得します
      operationId: getMasterPaymentFrequencies
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      frequencies:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              description: 支払い頻度ID
                            name:
                              type: string
                              description: 支払い頻度名
                          required:
                            - id
                            - name
        '401':
          $ref: '#/components/responses/Unauthorized'

  /master/subscription-statuses:
    get:
      tags:
        - マスターデータ
      summary: サブスクリプションステータス一覧の取得
      description: 利用可能なサブスクリプションステータスの一覧を取得します
      operationId: getMasterSubscriptionStatuses
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 正常に取得しました
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      statuses:
                        type: array
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              description: ステータスID
                            name:
                              type: string
                              description: ステータス名
                          required:
                            - id
                            - name
        '401':
          $ref: '#/components/responses/Unauthorized'
